$(function () { var sf = new Date().getTime(); $("#dg_yg").datagrid({ singleSelect: true, collapsible: true, url: '/xiangmuguanli/yg_getXiangmu', method: 'post', toolbar: '#yg_toolbar', pagination: true, rownumbers: true, fit: true, autoRowheight: false, queryParams: { xiangmu: dgtitle, loingid: loingid, username: username, dateshijian: sf }, onLoadSuccess: function (data) { $('.tianbiao').linkbutton({ text: '填表', plain: true }); $('.tianbiao').addClass("c6"); $('.tianbiao_jin').linkbutton({ text: '填表', disabled: true }); $('.tijiao').linkbutton({ text: '提交', plain: true }); $('.tijiao').addClass("c6"); $('.tijiao_jin').linkbutton({ text: '提交', disabled: true }); $('.rizhi').linkbutton({ text: '日志', plain: true }); $('.rizhi').addClass("c6"); var timelu = $('#dg_yg').datagrid('getRows').length; for (i = 0; i < timelu; i++) { $('#mb' + i).menubutton({ menu: '#mm3', duration: 2000000 }) }; $('.jianjie_all').tooltip({ position: 'left', onShow: function () { $(this).tooltip('tip').css({ width: '60%' }) } }) } }); var p = $('#dg_yg').datagrid('getPager'); $(p).pagination({ pageSize: 10, pageList: [5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80, 85, 90, 95, 100], beforePageText: '第', afterPageText: '页    共 {pages} 页', displayMsg: '当前显示 {from} - {to} 条记录   共 {total} 条记录', }); $('#XmName').textbox().textbox('addClearBtn', 'icon-clear'); $('#zongjine').textbox().textbox('addClearBtn', 'icon-clear'); $('#Beizhu').textbox().textbox('addClearBtn', 'icon-clear') }); $.extend($.fn.validatebox.defaults.rules, { checknameissame: { validator: function (value, param) { var name = value.trim(); var mulu = dgtitle; var result = ""; $.ajax({ type: 'post', async: false, url: '/xiangmuguanli/checkNameIsSame', data: { "name": name, "mulu": mulu }, success: function (data) { result = data } }); return result.indexOf("True") == 0 }, message: '该名称已经被占用' }, stringCheckSub: { validator: function (value) { return /^[\w\u4E00-\u9FA5（）《》【】\-(){}\[\]]+$/.test(value) }, message: "只能包括中文、英文字母、数字及（）《》[]【】(){}-等符号。" } }); $.extend($.fn.combobox.methods, { selectedIndex: function (jq, index) { if (!index) index = 0; var data = $(jq).combobox('options').data; var vf = $(jq).combobox('options').valueField; $(jq).combobox('setValue', eval('data[index].' + vf)) } }); $.extend($.fn.validatebox.defaults.rules, { isBlank: { validator: function (value, param) { return $.trim(value) != '' }, message: '不能为空，全空格也不行' } }); $.extend($.fn.textbox.methods, { addClearBtn: function (jq, iconCls) { return jq.each(function () { var t = $(this); var opts = t.textbox('options'); opts.icons = opts.icons || []; opts.icons.unshift({ iconCls: iconCls, handler: function (e) { $(e.data.target).textbox('clear').textbox('textbox').focus(); $(this).css('visibility', 'hidden') } }); t.textbox(); if (!t.textbox('getText')) { t.textbox('getIcon', 0).css('visibility', 'hidden') } t.textbox('textbox').bind('keyup', function () { var icon = t.textbox('getIcon', 0); if ($(this).val()) { icon.css('visibility', 'visible') } else { icon.css('visibility', 'hidden') } }) }) } }); function changdu(xm_name) { value1 = xm_name; if (value1.length > 15) { value1 = value1.substr(0, 15) + "..." } return value1 }; function InputAction(value, row, index) { return '<a href="javascript:void(0)" id="mb' + index + '" style="width:90%" class="easyui-menubutton c6" onclick="ShowMenu(' + index + ')">' + '更多' + '</a>' }; function ShowMenu(index) { $('#mm3').menu({ onClick: function (item) { if (item.id != undefined && eval(item.id) != undefined && $.isFunction(eval(item.id))) { item.onclick = eval(item.id + "(" + index + ")"); } } }) }; function newxm_yg() { $('#dlg').dialog('open').dialog('setTitle', '新增项目'); $('#fm').form('clear'); $('#XmName').textbox({ disabled: false }); url = '/xiangmuguanli/saveXiangmu?xiangmu=' + dgtitle + '&loingid=' + loingid + '&username=' + username; }; function editxm_yg() { var row = $('#dg_yg').datagrid('getSelected'); if (row) { var xmid = row.ID; $('#dlg_edit').dialog('open').dialog('setTitle', '编辑项目'); $('#fm_edit').form('load', row); url = '/xiangmuguanli/updateXiangmu?muluname=' + dgtitle + '&xmid=' + xmid } else { $.messager.alert("错误提示", "请选择要编辑的行！", "warning") } }; function saveXiangmu_edit() { $('#fm_edit').form('submit', { url: url, onSubmit: function () { return $(this).form('validate') }, success: function (result) { result = JSON.parse(result); if (result.success == false) { $.messager.show({ title: '错误提示', msg: result.errorMsg }) } if (result.success == true) { $('#dlg_edit').dialog('close'); $('#dg_yg').datagrid('reload'); $.messager.show({ title: '提示', msg: result.errorMsg }) } } }) }; function desxm_yg() { var row = $('#dg_yg').datagrid('getSelected'); if (row) { $.messager.confirm('提示', '您确定要删除这条记录吗？', function (r) { if (r) { $.post('/xiangmuguanli/delXiangmu', { id: row.ID, xmname: row.XmName, mulu: dgtitle }, function (result) { if (result.success) { $('#dg_yg').datagrid('reload'); } else { $.messager.show({ title: '错误提示', msg: result.errorMsg }) } }, 'json') } }) } else { $.messager.alert("错误提示", "请选择要删除的行！", "warning") } }; function saveXiangmu() { $('#fm').form('submit', { url: url, onSubmit: function () { return $(this).form('validate') }, success: function (result) { result = JSON.parse(result); $('#dlg').dialog('close'); $('#dg_yg').datagrid('reload'); if (result.success == false) { $.messager.show({ title: '错误提示', msg: result.errorMsg }) } else { $.messager.show({ title: '提示', msg: result.errorMsg }) } } }) }; function TitleFormatter(value, row, index) { var value1 = value; if (value1 == null) { var ss = '<a href="#" title="' + value + '" onclick="ygchakan(' + index + ')" class="easyui-tooltip"></a>'; return ss } else { if (value1.length > 15) { value1 = value1.substr(0, 15) + "..." } var ss = '<a href="#" title="' + value + '" onclick="ygchakan(' + index + ')" class="easyui-tooltip">' + value1 + '</a>'; return ss } }; function TitleFormatter_jj(value, row, index) { if (value == null) { var ss = ''; return ss } else { var value1 = value; if (value.length > 15) { value1 = value.substr(0, 15) + "..." } var ss = '<a href="javascript:;" title="' + value + '" class="jianjie_all">' + value1 + '</a>'; return ss } }; function bmfzrtubiao(value, row, index) { var bmfzrshenhe = row.bmfzrshenhe; switch (bmfzrshenhe) { case "通过": return "<Image src='/Scripts/easyui/themes/icons/ok.png' Title='通过'/>"; break; case "未审核": return "<Image src='/Scripts/easyui/themes/icons/question.png' Title='未审核'/>"; break; case "未通过": return "<Image src='/Scripts/easyui/themes/icons/no.png' Title='未通过'/>"; break } }; function fgldtubiao(value, row, index) { var fgldshenhe = row.fgldshenhe; switch (fgldshenhe) { case "通过": return "<Image src='/Scripts/easyui/themes/icons/ok.png' Title='通过'/>"; break; case "未审核": return "<Image src='/Scripts/easyui/themes/icons/question.png' Title='未审核'/>"; break; case "未通过": return "<Image src='/Scripts/easyui/themes/icons/no.png' Title='未通过'/>"; break } }; function ywzybubiao(value, row, index) { var ywzyshenhe = row.ywzyshenhe; switch (ywzyshenhe) { case "通过": return "<Image src='/Scripts/easyui/themes/icons/ok.png' Title='通过'/>"; break; case "未审核": return "<Image src='/Scripts/easyui/themes/icons/question.png' Title='未审核'/>"; break; case "未通过": return "<Image src='/Scripts/easyui/themes/icons/no.png' Title='未通过'/>"; break } }; function ygchakan(index) { $('#dg_yg').datagrid('selectRow', index); var row = $('#dg_yg').datagrid('getSelected'); if (row) { var name = row.XmName; var id = row.ID; var xmmulu = row.Xiangmumulu; var tabTitle = "查看：" + changdu(name); var url = "/xiangmuguanli/chakan?NoticeXmName=" + name + "&xmmulu=" + xmmulu + "&xmid=" + id; var icon = "icon-shenhe"; window.parent.addTab(tabTitle, url, icon); } }; function rowformater(value, row, index) { var tjzhuangtai = row.tijiaozhuantai; if (tjzhuangtai == "未提交") { return "<a href='javascript:void(0)' style='width:80%' class='tianbiao' onclick='wanshanxinxi(" + index + ")' target='mainFrame'>填表</a>" } else { return "<a href='javascript:void(0)' style='width:80%' class='tianbiao_jin'>填表</a>" } }; function wanshanxinxi(index) { $('#dg_yg').datagrid('selectRow', index); var row = $('#dg_yg').datagrid('getSelected'); if (row) { var name = row.XmName; var id = row.ID; var xmmulu = row.Xiangmumulu; var tabTitle = "填表：" + changdu(name); var url = "/xiangmuguanli/wanshanxinxi?NoticeXmName=" + name + "&xmmulu=" + xmmulu + "&xmid=" + id; var icon = "icon-edit"; window.parent.addTab(tabTitle, url, icon); } }; function yiwanshanxinxi() { $.messager.show({ title: '提示信息', msg: "记录已经完善并且提交，不能更改！" }) }; function yg_tijiao(value, row, index) { var zhi = row.tijiaozhuantai; if (zhi == "未提交") { return "<a href='javascript:void(0)' style='width:80%' class='tijiao' onclick='tijiao(" + index + ")' target='mainFrame'>提交</a>" } else { return "<a href='javascript:void(0)' style='width:80%' class='tijiao_jin'>提交</a>" } }; function tijiao(index) { $('#dg_yg').datagrid('selectRow', index); var row = $('#dg_yg').datagrid('getSelected'); if (row) { $('#tijiao_dlg').dialog('open').dialog('setTitle', '提示'); var name = row.XmName; var id = row.ID; var xmmulu = row.Xiangmumulu; url = "/xiangmuguanli/tijiao?loingid=" + loingid + "&shijian=" + sf + "&xmid=" + id } }; function tijiao_save() { $('#tijiao_fm').form('submit', { url: url, onSubmit: function () { return $(this).form('validate') }, success: function (result) { result = JSON.parse(result); if (result.Succeeded) { $('#tijiao_dlg').dialog('close'); $('#dg_yg').datagrid('reload'); $.messager.show({ title: '提示', msg: result.Succeeded }) } else { $.messager.show({ title: '提示', msg: result.errorMsg }) } } }) }; function ygxmrizhi(value, row, index) { return "<a href='javascript:void(0)' style='width:80%' class='rizhi' onclick='rizhichakan(" + index + ")' target='mainFrame'>日志</a>" }; function rizhichakan(index) { $('#dg_yg').datagrid('selectRow', index); var row = $('#dg_yg').datagrid('getSelected'); if (row) { var xmname = row.XmName; var id = row.ID; var xmmulu = row.Xiangmumulu; var tabTitle = "流程：" + changdu(xmname); var url = "/xiangmuguanli/liucheng?xmname=" + xmname + "&loingid=" + loingid + "&xmid=" + id; var icon = "icon-edit"; window.parent.addTab(tabTitle, url, icon); } }; function rizhi(index) { $('#dg_yg').datagrid('selectRow', index); var row = $('#dg_yg').datagrid('getSelected'); if (row) { var xmname = row.XmName; var id = row.ID; var xmmulu = row.Xiangmumulu; var tabTitle = "流程：" + changdu(xmname); var url = "/xiangmuguanli/liucheng?xmname=" + xmname + "&loingid=" + loingid + "&xmid=" + id; var icon = "icon-edit"; window.parent.addTab(tabTitle, url, icon); } }; function yidong(index) { $('#dg_yg').datagrid('selectRow', index); var row = $('#dg_yg').datagrid('getSelected'); if (row.tijiaozhuantai == "未提交" || row.ywzyshenhe == "未通过") { $('#ydmulu').textbox({ disabled: true }); if (row.lenght != 0) { var ID = row.ID; var xmmulu = row.Xiangmumulu; $('#dlg_mulu').dialog('open').dialog('setTitle', '更改项目目录'); $.ajax({ type: "POST", url: "/xiangmuguanli/mululist", dataType: "json", data: { xmmulu: xmmulu }, success: function (json) { if (json.length > 0) { $('#ydmulu').combobox({ data: json, valueField: 'id', textField: 'text', editable: false }); $('#ydmulu').combobox('selectedIndex', 0) } } }); url = '/xiangmuguanli/yidongmulu?loingid=' + loingid + '&ID=' + ID } else { $.messager.alert("错误提示", "请选择要更改目录的行！", "warning") } } else { $.messager.show({ title: '提示', msg: "当前项目还在审核流程中，不能移动！" }) } }; function mulu_save() { $('#fm_mulu').form('submit', { url: url, onSubmit: function () { return $(this).form('validate') }, success: function (result) { result = JSON.parse(result); if (result.success == false) { $.messager.show({ title: '错误提示', msg: result.errorMsg }) } if (result.success == true) { $('#dlg_mulu').dialog('close'); $('#dg_yg').datagrid('reload'); $.messager.show({ title: '提示', msg: result.errorMsg }) } } }) }; function daochu(index) { $('#dg_yg').datagrid('selectRow', index); var row = $('#dg_yg').datagrid('getSelected'); window.location.href = "excel_out?id=" + row.ID; };